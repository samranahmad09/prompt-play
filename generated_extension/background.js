'use strict';const STORAGE_KEYS={enabled:'enabled',blockedTotal:'blockedTotal',blockedSession:'blockedSession',lastUpdate:'lastUpdate',whitelist:'whitelist',source:'source'};const IDS={STATIC_SET:'rules_1',DYN_START:100000,WHITE_START:900000};async function getStorage(keys){return new Promise(r=>chrome.storage.local.get(keys,r))}async function setStorage(obj){return new Promise(r=>chrome.storage.local.set(obj,()=>r(true)))}async function initDefaults(){const s=await getStorage([STORAGE_KEYS.enabled,STORAGE_KEYS.blockedTotal,STORAGE_KEYS.blockedSession,STORAGE_KEYS.whitelist,STORAGE_KEYS.source]);const patch={};if(typeof s[STORAGE_KEYS.enabled]==='undefined') patch[STORAGE_KEYS.enabled]=true;if(typeof s[STORAGE_KEYS.blockedTotal]==='undefined') patch[STORAGE_KEYS.blockedTotal]=0;if(typeof s[STORAGE_KEYS.blockedSession]==='undefined') patch[STORAGE_KEYS.blockedSession]=0;if(!Array.isArray(s[STORAGE_KEYS.whitelist])) patch[STORAGE_KEYS.whitelist]=[];if(typeof s[STORAGE_KEYS.source]==='undefined') patch[STORAGE_KEYS.source]='stevenblack';if(Object.keys(patch).length) await setStorage(patch);const cur=await getStorage([STORAGE_KEYS.enabled]);await chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:cur[STORAGE_KEYS.enabled]?[IDS.STATIC_SET]:[],disableRulesetIds:cur[STORAGE_KEYS.enabled]?[]:[IDS.STATIC_SET]})}function notifyCounts(){chrome.runtime.sendMessage({type:'countsUpdated'}).catch?.(()=>{})}chrome.runtime.onInstalled.addListener(()=>{initDefaults()});chrome.runtime.onStartup.addListener(()=>{initDefaults()});chrome.declarativeNetRequest.onRuleMatchedDebug.addListener(async(info)=>{const s=await getStorage([STORAGE_KEYS.blockedTotal,STORAGE_KEYS.blockedSession,STORAGE_KEYS.enabled]);if(!s[STORAGE_KEYS.enabled]) return;await setStorage({[STORAGE_KEYS.blockedTotal]:(s.blockedTotal||0)+1,[STORAGE_KEYS.blockedSession]:(s.blockedSession||0)+1});notifyCounts()});async function setEnabled(on){await setStorage({[STORAGE_KEYS.enabled]:!!on});await chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:on?[IDS.STATIC_SET]:[],disableRulesetIds:on?[]:[IDS.STATIC_SET]});if(!on){const allDyn=await chrome.declarativeNetRequest.getDynamicRules();const ids=allDyn.map(r=>r.id);if(ids.length) await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:ids})}else{ /* keeping dynamic rules as-is when re-enabled */ }}function toRuleForHost(host, id){let h=host.trim().toLowerCase();if(!h||h.startsWith('#')||h.startsWith('localhost')||h.endsWith('.local')) return null;if(h.startsWith('www.')) h=h.slice(4);if(h.startsWith('0.0.0.0 ')||h.startsWith('127.0.0.1 ')){h=h.split(/\s+/)[1]||'';if(!h) return null}if(/[\s\/]/.test(h)) return null;return {id,priority:1,action:{type:'block'},condition:{urlFilter:'||'+h+'^',resourceTypes:['script','image','xmlhttprequest','sub_frame','stylesheet','font','media','websocket','other'],domainType:'thirdParty'}}}async function updateFromSource(source){let url='';if(source==='easyprivacy'){url='https://easylist-downloads.adblockplus.org/easyprivacy.txt'}else{url='https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts'}try{const res=await fetch(url,{cache:'no-store'});const text=await res.text();let rules=[];if(source==='easyprivacy'){const lines=text.split(/\n+/);for(const line of lines){const l=line.trim();if(!l||l.startsWith('!')||l.startsWith('[')) continue;if(l.startsWith('@@')) continue; // skip exceptions
if(l.startsWith('||')){const dom=l.replace(/^\|\|/,'').replace(/\^.*$/,'');const rule=toRuleForHost(dom, IDS.DYN_START+rules.length);if(rule) rules.push(rule)}else if(/^\d+\.\d+\.\d+\.\d+\s+/.test(l)){const dom=l.split(/\s+/)[1];const rule=toRuleForHost(dom, IDS.DYN_START+rules.length);if(rule) rules.push(rule)}}}else{const lines=text.split(/\n+/);for(const line of lines){const l=line.trim();if(!l||l.startsWith('#')) continue;const parts=l.split(/\s+/);const dom=parts[1]||'';const rule=toRuleForHost(dom, IDS.DYN_START+rules.length);if(rule) rules.push(rule)}}// limit to avoid exceeding dynamic cap
rules=rules.slice(0,1500);const existing=await chrome.declarativeNetRequest.getDynamicRules();const toRemove=existing.map(r=>r.id).filter(id=>id>=IDS.DYN_START && id<IDS.WHITE_START);if(toRemove.length) await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:toRemove});if(rules.length) await chrome.declarativeNetRequest.updateDynamicRules({addRules:rules});await setStorage({[STORAGE_KEYS.lastUpdate]:Date.now(),[STORAGE_KEYS.source]:source});return true}catch(e){console.error('Update list error',e);return false}}async function whitelistDomain(domain){if(!domain) return false;let host=domain.toLowerCase();if(host.startsWith('www.')) host=host.slice(4);const existing=await chrome.declarativeNetRequest.getDynamicRules();const already=existing.find(r=>r.action?.type==='allow' && r.condition?.initiatorDomains?.includes(host));if(already) return true;const id=IDS.WHITE_START + Math.floor(Math.random()*100000);const rule={id,priority:1000,action:{type:'allow'},condition:{initiatorDomains:[host],resourceTypes:['main_frame','sub_frame','stylesheet','script','image','font','object','xmlhttprequest','ping','csp_report','media','websocket','webtransport','webbundle','other']}};await chrome.declarativeNetRequest.updateDynamicRules({addRules:[rule]});const s=await getStorage([STORAGE_KEYS.whitelist]);const list=Array.isArray(s.whitelist)?s.whitelist:[];if(!list.includes(host)) list.push(host);await setStorage({[STORAGE_KEYS.whitelist]:list});return true}chrome.runtime.onMessage.addListener((msg, sender, sendResponse)=>{(async()=>{switch(msg?.type){case 'getState':{const s=await getStorage([STORAGE_KEYS.enabled,STORAGE_KEYS.blockedTotal,STORAGE_KEYS.blockedSession,STORAGE_KEYS.lastUpdate]);sendResponse({enabled:!!s.enabled,blockedTotal:s.blockedTotal||0,blockedSession:s.blockedSession||0,lastUpdate:s.lastUpdate||0});break}case 'toggleEnabled':{await setEnabled(!!msg.enabled);sendResponse(true);break}case 'resetCounters':{await setStorage({[STORAGE_KEYS.blockedSession]:0,[STORAGE_KEYS.blockedTotal]:0});notifyCounts();sendResponse(true);break}case 'updateList':{const ok=await updateFromSource(msg.source||'stevenblack');sendResponse(ok);break}case 'whitelistDomain':{const ok=await whitelistDomain(msg.domain||'');sendResponse(ok);break}case 'getRuleStats':{const statics=await chrome.declarativeNetRequest.getEnabledRulesets();const dyn=await chrome.declarativeNetRequest.getDynamicRules();sendResponse({staticCount:statics.includes(IDS.STATIC_SET)?'enabled':'disabled',dynamicCount:dyn.length});break}default: sendResponse(false)}})();return true});